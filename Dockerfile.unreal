# Unreal Engine 4.27 base image
FROM ghcr.io/epicgames/unreal-engine:dev-4.27

# Switch to root for installations
USER root

# ---------------------------------------------------------------------------
# 1. Install Vulkan + OpenGL utilities and Git (for AirSim)
# ---------------------------------------------------------------------------
RUN apt-get update && \
    apt-get install -y sudo --no-install-recommends \
        libvulkan1 \
        nano \
        vulkan-utils \
        mesa-utils \
        git \
        unzip && \
    rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------------------------
# 2. Clone AirSim repository
# ---------------------------------------------------------------------------
WORKDIR /home/ue4
RUN git clone https://github.com/microsoft/AirSim.git
RUN chown -R ue4:ue4 /home/ue4/AirSim
RUN echo "ue4 ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# ---------------------------------------------------------------------------
# 3. Build AirSim plugin non-interactively
# ---------------------------------------------------------------------------
USER ue4
WORKDIR /home/ue4/AirSim
RUN ./setup.sh && ./build.sh

# ---------------------------------------------------------------------------
# 4. Copy and prepare Alpha project
# ---------------------------------------------------------------------------
WORKDIR /home/ue4
COPY --chown=ue4:ue4 Alpha.zip /home/ue4/
RUN unzip Alpha.zip && rm Alpha.zip
RUN rm -rf /home/ue4/Alpha/Plugins && \
    cp -r /home/ue4/AirSim/Unreal/Environments/Blocks/Plugins /home/ue4/Alpha/

# ---------------------------------------------------------------------------
# 5. Build and package the project
# ---------------------------------------------------------------------------
RUN /home/ue4/UnrealEngine/Engine/Build/BatchFiles/RunUAT.sh BuildCookRun \
    -platform=Linux \
    -clientconfig=Shipping \
    -serverconfig=Shipping \
    -noP4 \
    -cook \
    -allmaps \
    -build \
    -stage \
    -prereqs \
    -pak \
    -archive \
    -archivedirectory=/home/ue4/Binaries/Alpha/ \
    -project=/home/ue4/Alpha/Alpha.uproject

# ---------------------------------------------------------------------------
# 6. Make binary executable
# ---------------------------------------------------------------------------
RUN chmod +x /home/ue4/Binaries/Alpha/LinuxNoEditor/Alpha.sh

# ---------------------------------------------------------------------------
# 7. Expose the AirSim RPC port (default 41451)
# ---------------------------------------------------------------------------
EXPOSE 41451

# ---------------------------------------------------------------------------
# 8. Default command
# ---------------------------------------------------------------------------
CMD ["/bin/bash"]
